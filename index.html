<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador GeoJSON Interactivo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos adicionales para asegurar que el mapa y la lista se muestren correctamente */
        #map {
            height: 500px;
            width: 66.66%;
            border-radius: 0.5rem;
            position: relative;
        }
        .lista-ordenada {
            margin-top: 0;
            list-style-position: inside;
            overflow-y: auto;
            max-height: 500px;
            width: 33.33%;
            padding-right: 1rem;
        }
        .lista-ordenada li {
             padding: 0.5rem 0;
             border-bottom: 1px solid rgba(229, 231, 235, 1);
        }
        .lista-ordenada li:last-child {
             border-bottom: none;
        }
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
        }
        #file-input {
            margin-bottom: 20px;
        }
        .container {
            padding: 20px;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin: 20px auto;
            max-width: 90%;
            flex-direction: column;
        }
        #file-selection{
            width: 100%;
            margin-bottom: 1rem;
            display: flex; /* Añadimos flexbox para alinear label y select */
            flex-direction: column;
            align-items: flex-start; /* Alineamos los elementos al inicio */
        }
        #province-select {
            margin-bottom: 0; /* Eliminamos el margen inferior del select */
            padding: 0.375rem 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            width: 200px; /* Ancho fijo para el select */
            font-size: 0.875rem;
            height: auto; /* Aseguramos que la altura se ajuste al contenido */
        }
        .map-and-list {
            display: flex;
            flex-direction: row;
            width: 100%;
            align-items: stretch;
            margin-top: 1rem;
        }
        #file-selection label {
            margin-bottom: 0.25rem; /* Añadimos un pequeño margen inferior al label */
        }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <div class="container">
        <div id="file-selection" class="mb-4">
            <label for="province-select" class="block text-gray-700 text-sm font-bold mb-2">Selecciona una provincia:</label>
            <select id="province-select" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <option value="" disabled selected>Selecciona una provincia</option>
            </select>
            <p id="file-input-error" class="text-red-500 text-xs italic" style="display: none;">Por favor, selecciona un archivo GeoJSON.</p>
        </div>
        <div class="map-and-list">
            <div id="map"></div>
            <ol id="resultados-lista" class="lista-ordenada">
            </ol>
        </div>
    </div>
    <script>
        const valenciaCoordinates = [39.4667, -0.3750];
        const zoomLevel = 9;
        const map = L.map('map').setView(valenciaCoordinates, zoomLevel);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        const resultadosLista = document.getElementById('resultados-lista');
        const provinceSelect = document.getElementById('province-select');
        const fileInputError = document.getElementById('file-input-error');

        const archivosGeoJSON = [
            'Alicante.geojson',
            'Castellon.geojson',
            'Valencia.geojson'
        ];

        let geojsonLayer;

        function cargarArchivosGeoJSON() {
            provinceSelect.innerHTML = '<option value="" disabled selected>Selecciona una provincia</option>';
            archivosGeoJSON.forEach(archivo => {
                const nombreProvincia = archivo.replace('.geojson', '');
                const option = document.createElement('option');
                option.value = archivo;
                option.textContent = nombreProvincia;
                provinceSelect.appendChild(option);
            });

            provinceSelect.addEventListener('change', (event) => {
                const selectedFile = event.target.value;
                if (selectedFile) {
                    fetch(selectedFile)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`Error al cargar el archivo: ${selectedFile}`);
                            }
                            return response.json();
                        })
                        .then(geojsonData => {
                            displayGeoJSONData(geojsonData);
                        })
                        .catch(error => {
                            console.error("Error al cargar o procesar GeoJSON:", error);
                            resultadosLista.innerHTML += `<li class="text-red-500">Error al cargar el archivo ${selectedFile}. Por favor, verifica la ruta y el formato. Detalles: ${error.message}</li>`;
                        });
                }
            });
        }

        function displayGeoJSONData(geojsonData) {
            resultadosLista.innerHTML = '';
            try {
                if (!geojsonData || typeof geojsonData !== 'object' || geojsonData.type !== 'FeatureCollection') {
                    throw new Error("No es un objeto GeoJSON válido. Debe ser un FeatureCollection.");
                }
                if (!geojsonData.features || !Array.isArray(geojsonData.features)) {
                    throw new Error("El objeto GeoJSON debe contener un array de 'features'.");
                }

                if (geojsonLayer) {
                    map.removeLayer(geojsonLayer);
                }

                // Filtrar features para mostrar solo los que tienen una altura mayor o igual a 1000 metros
                const filteredFeatures = geojsonData.features.filter(feature => {
                    const altura = feature.properties.ele;
                    return typeof altura === 'number' && altura >= 1000;
                });

                // Crear un nuevo objeto GeoJSON con las features filtradas
                const filteredGeojsonData = { ...geojsonData, features: filteredFeatures };

                geojsonLayer = L.geoJSON(filteredGeojsonData, {
                    onEachFeature: function (feature, layer) {
                        if (feature.geometry && feature.geometry.type === 'Point' && Array.isArray(feature.geometry.coordinates)) {
                            const lat = feature.geometry.coordinates[1];
                            const lng = feature.geometry.coordinates[0];
                            const popupContent = `<b>${feature.properties.name || 'Sin nombre'}</b><br>
                                                  Altura: ${feature.properties.ele || 'N/A'} m<br>
                                                  <a href="https://www.google.com/maps/place/${lat},${lng}" target="_blank">Ver en Google Maps</a>`;
                            layer.bindPopup(popupContent);
                        }
                    }
                }).addTo(map);

                const bounds = geojsonLayer.getBounds();
                if (bounds.isValid()) {
                    map.fitBounds(bounds);
                }

                let listaHTML = '';
                let elementCount = 0;
                const elementos = [];
                filteredGeojsonData.features.forEach(feature => { // Usamos filteredGeojsonData.features
                    elementCount++;
                    let nombre = "Sin nombre";
                    let tipo = "Elemento";
                    let lat = null;
                    let lng = null;
                    let altura = feature.properties.ele || null; // Accedemos a la altura usando feature.properties
                    if (feature.geometry && feature.geometry.type === 'Point' && Array.isArray(feature.geometry.coordinates)) {
                        lat = feature.geometry.coordinates[1];
                        lng = feature.geometry.coordinates[0];
                    }
                    nombre = feature.properties && feature.properties.name ? feature.properties.name : "Sin nombre";
                    elementos.push({ nombre, tipo, lat, lng, altura });
                });
                elementos.sort((a, b) => {
                    if (a.altura === null) return 1;
                    if (b.altura === null) return -1;
                    return b.altura - a.altura;
                });
                elementos.forEach(elemento => {
                    if (elemento.altura >= 1000) {
                        listaHTML += `<li><a href="https://www.google.com/maps/place/${elemento.lat},${elemento.lng}" target="_blank">${elemento.nombre}</a> - Altura: ${elemento.altura ? elemento.altura + ' m' : 'N/A'}</li>`;
                    }
                });
                if (elementCount === 0) {
                    listaHTML = `<li class="text-gray-500">No se encontraron elementos que superen los 1000 metros de altura en el archivo GeoJSON.</li>`;
                }
                resultadosLista.innerHTML = listaHTML;
            } catch (error) {
                console.error("Error al procesar GeoJSON:", error);
                resultadosLista.innerHTML = `<li class="text-red-500">Error al procesar el archivo GeoJSON. Por favor, verifica el formato. Detalles: ${error.message}</li>`;
            }
        }

        window.onload = cargarArchivosGeoJSON;
    </script>
</body>
</html>


