<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador GeoJSON Interactivo</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* Estilos adicionales para asegurar que el mapa y la lista se muestren correctamente */
        #map {
            height: 500px;
            width: 66.66%;
            border-radius: 0.5rem;
            position: relative;
        }
        .lista-ordenada {
            margin-top: 0;
            list-style-position: inside;
            overflow-y: auto;
            max-height: 450px;
            width: 33.33%;
            padding-right: 1rem;
        }
        .lista-ordenada li {
             padding: 0.5rem 0;
             border-bottom: 1px solid rgba(229, 231, 1);
        }
        .lista-ordenada li:last-child {
             border-bottom: none;
        }
        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
        }
        #file-input {
            margin-bottom: 20px;
        }
        .container {
            padding: 20px;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin: 20px auto;
            max-width: 90%;
            flex-direction: column;
        }
        #file-selection{
            width: 100%;
            margin-bottom: 1rem;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }
        #province-select {
            margin-bottom: 0;
            padding: 0.375rem 0.75rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            width: 200px;
            font-size: 0.875rem;
            height: auto;
        }
        .map-and-list {
            display: flex;
            flex-direction: row;
            width: 100%;
            align-items: stretch;
            margin-top: 1rem;
        }
        #file-selection label {
            margin-bottom: 0.25rem;
        }
        #peak-count {
            margin-top: 1rem;
            font-size: 1.25rem;
            font-weight: bold;
            text-align: center;
            width: 66.66%;
            margin-left: auto;
            margin-right: auto;
        }
        #peak-count span {
            color: #dc2626;
        }
    </style>
</head>
<body class="bg-gray-100 p-4">
    <div class="container">
        <div id="file-selection" class="mb-4">
            <label for="province-select" class="block text-gray-700 text-sm font-bold mb-2">Selecciona una provincia:</label>
            <select id="province-select" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline">
                <option value="" disabled selected>Selecciona una provincia</option>
            </select>
            <p id="file-input-error" class="text-red-500 text-xs italic" style="display: none;">Por favor, selecciona un archivo GeoJSON.</p>
        </div>
        <div class="map-and-list">
            <div id="map"></div>
            <ol id="resultados-lista" class="lista-ordenada">
            </ol>
        </div>
        <div id="peak-count"></div>
    </div>
    <script>
        const valenciaCoordinates = [39.4667, -0.3750];
        const zoomLevel = 9;
        const map = L.map('map').setView(valenciaCoordinates, zoomLevel);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);
        const resultadosLista = document.getElementById('resultados-lista');
        const provinceSelect = document.getElementById('province-select');
        const fileInputError = document.getElementById('file-input-error');
        const peakCountElement = document.getElementById('peak-count');

        let geojsonLayer; // Declarar geojsonLayer en el ámbito global

        // Función para obtener la lista de archivos GeoJSON del directorio
        function cargarArchivosGeoJSON() {
            // Lista de nombres de archivo GeoJSON
            const archivosGeoJSON = [
                "Alava.geojson",        "Albacete.geojson",     "Alicante.geojson",
                "Almeria.geojson",      "Asturias.geojson",     "Avila.geojson",
                "Badajoz.geojson",      "Barcelona.geojson",    "Burgos.geojson",
                "Caceres.geojson",      "Castellon.geojson",    "Valencia.geojson"
                // Asegúrate de que ESTOS NOMBRES DE ARCHIVO COINCIDAN EXACTAMENTE con los que tienes.
                // ¡Incluyendo mayúsculas/minúsculas y la extensión .geojson!
            ];

            provinceSelect.innerHTML = '<option value="" disabled selected>Selecciona una provincia</option>';
            archivosGeoJSON.forEach(archivo => {
                const nombreProvincia = archivo.replace('.geojson', ''); // Elimina .geojson
                const option = document.createElement('option');
                option.value = archivo;  // Usa el nombre del archivo como valor
                option.textContent = nombreProvincia;
                provinceSelect.appendChild(option);
            });

            provinceSelect.addEventListener('change', (event) => {
                const selectedFile = event.target.value;
                if (selectedFile) {
                    fetch(selectedFile) // Usa la ruta directa al archivo
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`Error al cargar el archivo: ${selectedFile}`);
                            }
                            return response.json();
                        })
                        .then(geojsonData => {
                            displayGeoJSONData(geojsonData);
                        })
                        .catch(error => {
                            console.error("Error al cargar o procesar GeoJSON:", error);
                            resultadosLista.innerHTML += `<li class="text-red-500">Error al cargar el archivo ${selectedFile}. Por favor, verifica la ruta y el formato. Detalles: ${error.message}</li>`;
                        });
                }
            });
        }

        function displayGeoJSONData(geojsonData) {
            resultadosLista.innerHTML = '';
            try {
                if (!geojsonData || typeof geojsonData !== 'object' || geojsonData.type !== 'FeatureCollection') {
                    throw new Error("No es un objeto GeoJSON válido. Debe ser un FeatureCollection.");
                }
                if (!geojsonData.features || !Array.isArray(geojsonData.features)) {
                    throw new Error("El objeto GeoJSON debe contener un array de 'features'.");
                }

                // Eliminar la capa anterior si existe
                if (geojsonLayer) {
                    map.removeLayer(geojsonLayer);
                }

                const filteredFeatures = geojsonData.features.filter(feature => {
                    let altura = feature.properties.ele;
                    if (typeof altura !== 'number') {
                         altura = parseInt(feature.properties.ele);
                    }
                    return typeof altura === 'number' && altura >= 1000;
                });

                const filteredGeojsonData = { ...geojsonData, features: filteredFeatures };
                const numberOfPicos = filteredGeojsonData.features.length;

                geojsonLayer = L.geoJSON(filteredGeojsonData, { // Asignar a la variable global
                    onEachFeature: function (feature, layer) {
                        if (feature.geometry && feature.geometry.type === 'Point' && Array.isArray(feature.geometry.coordinates)) {
                            const lat = feature.geometry.coordinates[1];
                            const lng = feature.geometry.coordinates[0];
                            const popupContent = `<b>${feature.properties.name || 'Sin nombre'}</b><br>
                                                  Altura: ${feature.properties.ele || 'N/A'} m<br>
                                                  <a href="https://www.google.com/maps/place/$$${lat},${lng}" target="_blank">Ver en Google Maps</a>`;
                            layer.bindPopup(popupContent);
                        }
                    }
                }).addTo(map);

                const bounds = geojsonLayer.getBounds();
                if (bounds.isValid()) {
                    map.fitBounds(bounds);
                }

                let listaHTML = '';
                let elementCount = 0;
                const elementos = [];
                filteredGeojsonData.features.forEach(feature => {
                    elementCount++;
                    let nombre = "Sin nombre";
                    let tipo = "Elemento";
                    let lat = null;
                    let lng = null;
                    let altura = feature.properties.ele || null;
                    if (typeof altura !== 'number') {
                        altura = parseInt(feature.properties.ele);
                    }
                    if (feature.geometry && feature.geometry.type === 'Point' && Array.isArray(feature.geometry.coordinates)) {
                        lat = feature.geometry.coordinates[1];
                        lng = feature.geometry.coordinates[0];
                    }
                    nombre = feature.properties && feature.properties.name ? feature.properties.name : "Sin nombre";
                    elementos.push({ nombre, tipo, lat, lng, altura });
                });
                elementos.sort((a, b) => {
                    if (a.altura === null) return 1;
                    if (b.altura === null) return -1;
                    return b.altura - a.altura;
                });
                elementos.forEach(elemento => {
                    listaHTML += `<li><a href="https://www.google.com/maps/place/$${elemento.lat},${elemento.lng}" target="_blank">${elemento.nombre}</a> - Altura: ${elemento.altura ? elemento.altura + ' m' : 'N/A'}</li>`;
                });
                if (elementCount === 0) {
                    listaHTML = `<li class="text-gray-500">No se encontraron elementos que superen los 1000 metros de altura en el archivo GeoJSON.</li>`;
                }
                resultadosLista.innerHTML = listaHTML;
                peakCountElement.innerHTML = `<b>Total de picos de más de 1000 metros: </b><span>${numberOfPicos}</span>`;
            } catch (error) {
                console.error("Error al procesar GeoJSON:", error);
                resultadosLista.innerHTML = `<li class="text-red-500">Error al procesar el archivo GeoJSON. Por favor, verifica el formato. Detalles: ${error.message}</li>`;
                peakCountElement.textContent = '';
            }
        }

        window.onload = cargarArchivosGeoJSON;
    </script>
</body>
</html>
```

**He hecho los siguientes cambios, y es crucial que los revises cuidadosamente:**

1.  **Declaración de `geojsonLayer`:** He movido `let geojsonLayer;` *fuera* de cualquier función, al principio del `<script>`, para que sea una variable global. Esto asegura que se defina *antes* de que se use en `displayGeoJSONData`.
2.  **Asignación de `geojsonLayer`:** Dentro de `displayGeoJSONData`, me he asegurado de que el resultado de `L.geoJSON()` se *asigne* a la variable global `geojsonLayer`:
    ```javascript
    geojsonLayer = L.geoJSON(filteredGeojsonData, { ... }).addTo(map);
    ```
    Esto es fundamental para que la capa creada por Leaflet se guarde en la variable global y pueda ser eliminada en la siguiente llamada a la función.

**Verifica lo Siguiente:**

* **Nombres de Archivo:** Revisa *cuidadosamente* que los nombres en `archivosGeoJSON` coincidan exactamente con tus archivos (incluyendo mayúsculas y minúsculas).
* **Ubicación de Archivos:** Asegúrate de que los archivos `.geojson` estén en la misma carpeta que tu archivo HTML, o ajusta las rutas en `archivosGeoJSON` si están en una subcarpeta.
* **Contenido de GeoJSON:** Abre uno o dos de tus archivos `.geojson` en un editor de texto o un visor GeoJSON para confirmar que son archivos GeoJSON válidos y que contienen datos (features) con coordenadas y una propiedad "ele" (altura).  Un GeoJSON inválido también puede causar que no se muestre nada.
* **Consola del Navegador:** Abre la consola de tu navegador (Ctrl+Shift+J o F12) y busca errores de JavaScript.  Copia *cualquier* error que veas y pégalo aquí.  Esto me dará más pistas.

Por favor, revisa estos puntos con atención. El error "geojsonLayer is not defined" debería estar resuelto con este código, pero es importante descartar otros problem
